name: Build & Release YTGet (Nuitka Windows)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag Name to Release'
        required: true

permissions:
  contents: write

env:
  APP_NAME: YTGet
  ENTRY_POINT: ytget_gui/main.py
  TOOLS_DIR: ${{ github.workspace }}\tools
  DIST_ROOT: ${{ github.workspace }}\dist

jobs:
  build-windows:
    name: Build (windows-latest - x86_64)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare workspace folders
        run: |
          New-Item -ItemType Directory -Force -Path "${{ env.TOOLS_DIR }}" | Out-Null
          New-Item -ItemType Directory -Force -Path "${{ env.DIST_ROOT }}" | Out-Null
        shell: pwsh

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python dependencies and Nuitka (stable)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          # Install the latest stable Nuitka available on PyPI (2.8.9 at time of writing)
          pip install "nuitka==2.8.9"
          # If you prefer to install the latest development version from GitHub, uncomment:
          # pip install --upgrade git+https://github.com/Nuitka/Nuitka.git
          python -V
          python -m nuitka --version
        shell: pwsh

      - name: Download Deno into tools
        run: |
          $denoUrl = 'https://github.com/denoland/deno/releases/download/v2.5.6/deno-x86_64-pc-windows-msvc.zip'
          Invoke-WebRequest -Uri $denoUrl -OutFile "${{ env.TOOLS_DIR }}\deno.zip"
          Expand-Archive -Path "${{ env.TOOLS_DIR }}\deno.zip" -DestinationPath "${{ env.TOOLS_DIR }}\deno_dir" -Force
          Copy-Item -Path "${{ env.TOOLS_DIR }}\deno_dir\deno.exe" -Destination "${{ env.TOOLS_DIR }}\deno.exe" -Force
        shell: pwsh

      - name: Download yt-dlp into tools
        run: |
          $yt = 'https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe'
          Invoke-WebRequest -Uri $yt -OutFile "${{ env.TOOLS_DIR }}\yt-dlp.exe"
        shell: pwsh

      - name: Download ffmpeg & ffprobe into tools
        run: |
          $ffUrl = 'https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip'
          Invoke-WebRequest -Uri $ffUrl -OutFile "${{ env.TOOLS_DIR }}\ffmpeg.zip"
          Expand-Archive -Path "${{ env.TOOLS_DIR }}\ffmpeg.zip" -DestinationPath "${{ env.TOOLS_DIR }}\ffmpeg_dir" -Force
          $ffmpeg = Get-ChildItem -Path "${{ env.TOOLS_DIR }}\ffmpeg_dir" -Recurse -Filter ffmpeg.exe | Select-Object -First 1
          $ffprobe = Get-ChildItem -Path "${{ env.TOOLS_DIR }}\ffmpeg_dir" -Recurse -Filter ffprobe.exe | Select-Object -First 1
          Copy-Item -Path $ffmpeg.FullName -Destination "${{ env.TOOLS_DIR }}\ffmpeg.exe" -Force
          Copy-Item -Path $ffprobe.FullName -Destination "${{ env.TOOLS_DIR }}\ffprobe.exe" -Force
        shell: pwsh

      - name: Download PhantomJS into tools
        run: |
          $winUrl = 'https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-windows.zip'
          Invoke-WebRequest -Uri $winUrl -OutFile "${{ env.TOOLS_DIR }}\phantomjs.zip"
          Expand-Archive -Path "${{ env.TOOLS_DIR }}\phantomjs.zip" -DestinationPath "${{ env.TOOLS_DIR }}\phantomjs_dir" -Force
          Copy-Item -Path "${{ env.TOOLS_DIR }}\phantomjs_dir\phantomjs-2.1.1-windows\bin\phantomjs.exe" -Destination "${{ env.TOOLS_DIR }}\phantomjs.exe" -Force
        shell: pwsh

      - name: Build with Nuitka (standalone folder)
        run: |
          $out = "${{ env.DIST_ROOT }}\${{ env.APP_NAME }}"
          if (Test-Path $out) { Remove-Item -Recurse -Force $out }
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          # Use the DIST env var for output-dir to avoid quoting issues
          $distArg = "--output-dir=$out"
          python -m nuitka `
            --standalone `
            $distArg `
            --enable-plugin=pyside6 `
            --include-package=ytget_gui `
            --include-data-dir=ytget_gui=ytget_gui `
            --include-data-file=ytget_gui/icon.ico=icon.ico `
            --nofollow-import-to=tests `
            --remove-output `
            --assume-yes-for-downloads `
            "${{ env.ENTRY_POINT }}"
        env:
          DIST: ${{ env.DIST_ROOT }}\${{ env.APP_NAME }}
        shell: pwsh

      - name: Copy external tools into dist folder
        run: |
          $tools = "${{ env.TOOLS_DIR }}"
          $dist = "${{ env.DIST_ROOT }}\${{ env.APP_NAME }}"
          Copy-Item -Path (Join-Path $tools 'deno.exe') -Destination $dist -Force -ErrorAction SilentlyContinue
          Copy-Item -Path (Join-Path $tools 'yt-dlp.exe') -Destination $dist -Force -ErrorAction SilentlyContinue
          Copy-Item -Path (Join-Path $tools 'ffmpeg.exe') -Destination $dist -Force -ErrorAction SilentlyContinue
          Copy-Item -Path (Join-Path $tools 'ffprobe.exe') -Destination $dist -Force -ErrorAction SilentlyContinue
          Copy-Item -Path (Join-Path $tools 'phantomjs.exe') -Destination $dist -Force -ErrorAction SilentlyContinue
        shell: pwsh

      - name: Smoke test (basic)
        run: |
          $dist = "${{ env.DIST_ROOT }}\${{ env.APP_NAME }}"
          $exe = Get-ChildItem -Path $dist -Recurse -Filter "${{ env.APP_NAME }}.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $exe) {
            & $exe.FullName --version
          } else {
            Write-Host "No main executable found for smoke test; continuing."
          }
        shell: pwsh

      - name: Package build (zip)
        run: |
          $dist = "${{ env.DIST_ROOT }}\${{ env.APP_NAME }}"
          $zip = "${{ github.workspace }}\YTGet-windows.zip"
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Path (Join-Path $dist '*') -DestinationPath $zip -Force -CompressionLevel Optimal
        shell: pwsh

      - name: Generate SHA-256 checksum
        run: |
          $zip = "${{ github.workspace }}\YTGet-windows.zip"
          certutil -hashfile $zip SHA256 | Out-File -FilePath "${{ github.workspace }}\YTGet-windows.sha256" -Encoding ascii
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64
          path: |
            YTGet-windows.zip
            YTGet-windows.sha256
            dist/**

  release:
    name: Create GitHub Release
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: "${{ github.event.inputs.tag || github.ref_name }}"
          body_path: RELEASE_NOTES.md
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
